version: '3'

services:
  splash:
    image: scrapinghub/splash
    command: --max-timeout 3600 --slots 10 --maxrss 3000 --verbosity 0
    environment:
      - DFK_TEST=testserver:12345
    restart: always
    ports:
      - "8050:8050"
    volumes:
      - ./splash/filters:/etc/splash/filters:ro

  # redis:
  #   image: redis
  #   restart: always
  #   ports:
  #     - "6379:6379"
    
  cassandra:
    #image: cassandra
    build: ./storage/cassandra
    restart: always
    environment:
      # define cluster topology
      - CASSANDRA_CLUSTER_NAME=dfk-db
      - CASSANDRA_DC=dfk-east
      - CASSANDRA_ENDPOINT_SNITCH=GossipingPropertyFileSnitch

      # define gossip entrypoints
      #- CASSANDRA_SEEDS=cassandra,cassandra2,cassandra3
      - CASSANDRA_SEEDS=cassandra 

      # define heap size for local development
      - MAX_HEAP_SIZE=500M
      - HEAP_NEWSIZE=100M

      # open JMX port for access by Reaper
      # WARNING: this is unsafe in production without proper firewall settings
      - LOCAL_JMX=yes    

    ports:
      - "7199:7199" # JMX
      - "7000:7000" # cluster communication
      - "7001:7001" # cluster communication (SSL)
      - "9042:9042" # native protocol clients
      - "9160:9160" # thrift clients
    volumes:
#      - ./cassandra/config/collectd.cassandra.conf:/etc/collectd/collectd.conf
#     - ./cassandra/config/graphite.cassandra.yaml:/etc/cassandra/graphite.yaml
#     - ./cassandra/config/filebeat.yml:/etc/filebeat/filebeat.yml
#      - ./cassandra/config/prometheus.yml:/prometheus/prometheus.yml
      - ./storage/cassandra/db:/var/lib/cassandra
      - ./storage/cassandra/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d
    

  testserver:
    #build: ./testserver
    image: slotix/dfk-testserver
    environment:
      - SPLASH=splash:8050
      - DFK_TEST=testserver:12345
    ports:
      - "12345:12345"
    depends_on:
      - splash
    restart: always
  