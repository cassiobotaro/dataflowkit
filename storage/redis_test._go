package storage

import (
	"testing"
	"time"

	"github.com/stretchr/testify/assert"
)

func TestRedis(t *testing.T) {
	// viper.Set("REDIS", "127.0.0.1:6379")
	// viper.Set("REDIS_NETWORK", "tcp")
	// viper.Set("REDIS_PASSWORD", "")
	// viper.Set("REDIS_DB", "Redis DB")
	//viper.Set("REDIS_SOCKET_PATH", "")
	redisCon := NewRedisConn("127.0.0.1:6379", "tcp", "", 0)
	//redisCon := NewRedisConn()
	conn := redisCon.open()
	//redisCon.conn = &conn
	defer conn.Close()

	//Delete all values from redis if any
	err := redisCon.DeleteAll()
	testKey := "some key"
	testValue := []byte("some value")
	rec := Record{
		Key:     testKey,
		Value:   testValue,
		ExpTime: 100,
	}
	anotherRec := Record{
		Key:     "AnotherKey",
		Value:   []byte("Another value"),
		ExpTime: 100,
	}

	//Write some values to Redis
	err = redisCon.Write(rec)
	assert.Nil(t, err, "Expected no error")
	err = redisCon.Write(anotherRec)
	assert.Nil(t, err, "Expected no error")

	//Read from Redis
	value, err := redisCon.Read(rec)
	assert.Nil(t, err, "Expected no error")
	assert.Equal(t, value, testValue, "Expected value = testValue")

	//numeric, err := redisCon.ReadInt("numeric key")
	//assert.Nil(t, err, "Expected no error")
	//assert.Equal(t, numeric, int64(18), "Expected numeric = 18")

	//Expirations
	expIn := int64(50)
	ttl, err := redisCon.TTL(testKey)
	t.Log(ttl, err)
	err = redisCon.ExpireIn(testKey, expIn)
	assert.Nil(t, err, "Expected no error")
	ttl, err = redisCon.TTL(testKey)
	t.Log(ttl, err)
	assert.Nil(t, err, "Expected no error")
	assert.Equal(t, true, ttl > 0, "Expected TTL >0")

	//EXPIREAT
	expAt := time.Now().UTC().Add(time.Duration(24 * time.Hour))
	t.Log(expAt)
	err = redisCon.SetExpireAt(testKey, expAt.Unix())
	assert.Nil(t, err, "Expected no error")
	ttl, err = redisCon.TTL(testKey)
	t.Log(ttl, err)
	assert.Nil(t, err, "Expected no error")
	assert.Equal(t, true, ttl > 0, "Expected TTL >0")

	exp := redisCon.Expired(rec)
	//logger.Info(TTL)
	assert.Equal(t, exp, false, "Expected Not expired")

	err = redisCon.SetTTL(testKey, -1)
	exp = redisCon.Expired(rec)
	assert.Equal(t, exp, true, "Expected expired value")

	err = redisCon.Delete(anotherRec)
	assert.Nil(t, err, "Expected no error")
	err = redisCon.DeleteAll()
	assert.Nil(t, err, "Expected no error")
	//err := redisCon.Write("test", []byte("fff"), 0)
	//t.Log(err)
}
